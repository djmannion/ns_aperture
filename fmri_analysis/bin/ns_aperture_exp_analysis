#! /usr/bin/env python

"""Runs a single-subject analysis step in the Glass coherence block fMRI
experiment"""

import os
import argparse

import ns_aperture.config, ns_aperture.fmri_analysis.paths
import ns_aperture.fmri_analysis.preproc
import ns_aperture.fmri_analysis.exp_analysis

def main():
	"""Execution function"""

	desc = """Runs a single-subject analysis step in the Glass coherence block
	          fMRI experiment"""

	eg = """
	Steps:
	  design : prepares the design info
	  glm : executes the GLM analysis.
	  beta_to_psc : converts the fitted beta values to percent signal change.
	  roi_xtr : extracts the ROI statistics.
	
	---N.B.---
	
	* The script must be run from the ns_aperture/fmri_analysis/bin directory.
	
	"""

	target_dir = "ns_aperture/fmri_analysis/bin"

	current_dir = os.getcwd()

	if current_dir[ -len( target_dir ): ] != target_dir:
		raise IOError( "Script needs to be launched from %s" % target_dir )

	# use this formatter so we can supply our own indentation
	fmt = argparse.RawDescriptionHelpFormatter

	parser = argparse.ArgumentParser( description = desc,
	                                  epilog = eg,
	                                  formatter_class = fmt,
	                                )

	parser.add_argument( "subj_id",
	                     help = "Subject identifier"
	                   )

	proc_steps = ( "design",
	               "glm",
	               "beta_to_psc",
	               "roi_xtr",
	               "roi_mean"
	             )

	parser.add_argument( "proc_step",
	                     choices = proc_steps,
	                     help = "Processing step"
	                   )

	args = parser.parse_args()

	# check the arguments are valid
	if len( args.subj_id ) != 5 or args.subj_id[ 0 ] != "s":
		raise ValueError( "Subject ID needs to be in the format of sXXXX" )

	# load the experiment / subject info
	conf = ns_aperture.config.get_conf( args.subj_id )
	paths = ns_aperture.fmri_analysis.paths.get_subj_paths( conf )

	if args.proc_step == "design":
		ns_aperture.fmri_analysis.exp_analysis.exp_design_prep( paths, conf )

	elif args.proc_step == "glm":
		ns_aperture.fmri_analysis.exp_analysis.glm( paths, conf )

	elif args.proc_step == "beta_to_psc":
		ns_aperture.fmri_analysis.exp_analysis.beta_to_psc( paths, conf )

	elif args.proc_step == "roi_xtr":
		ns_aperture.fmri_analysis.exp_analysis.roi_xtr( paths, conf )

	elif args.proc_step == "roi_mean":
		ns_aperture.fmri_analysis.exp_analysis.roi_mean( paths, conf )

	else:
		print "Not completed"


if __name__ == "__main__":
	main()
